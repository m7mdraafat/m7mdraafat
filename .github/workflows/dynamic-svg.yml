name: Generate Dynamic Profile SVGs

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  generate-svg:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Create SVG Generator
        run: |
          mkdir -p dynamic-svg
          cat > generate-svg.js << 'EOF'
          const https = require('https');
          const fs = require('fs');

          const username = 'm7mdraafat';

          function fetchGitHubData() {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'api.github.com',
                path: `/users/${username}`,
                headers: { 'User-Agent': 'GitHub-Profile-Generator' }
              };
              https.get(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              }).on('error', reject);
            });
          }

          function styleParticles(userData, greeting) {
            return `<svg width="800" height="180" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="bg1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#0d1117"/>
                <stop offset="50%" style="stop-color:#1a1a2e"/>
                <stop offset="100%" style="stop-color:#16213e"/>
              </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#bg1)" rx="10"/>
            <circle cx="50" cy="50" r="2" fill="#58a6ff" opacity="0.6">
              <animate attributeName="cy" values="50;130;50" dur="4s" repeatCount="indefinite"/>
            </circle>
            <circle cx="150" cy="90" r="1.5" fill="#58a6ff" opacity="0.4">
              <animate attributeName="cy" values="90;30;90" dur="3s" repeatCount="indefinite"/>
            </circle>
            <circle cx="650" cy="70" r="2" fill="#58a6ff" opacity="0.5">
              <animate attributeName="cy" values="70;150;70" dur="5s" repeatCount="indefinite"/>
            </circle>
            <circle cx="750" cy="100" r="1" fill="#c0c0c0" opacity="0.4">
              <animate attributeName="cy" values="100;40;100" dur="3.5s" repeatCount="indefinite"/>
            </circle>
            <circle cx="300" cy="30" r="1.5" fill="#58a6ff" opacity="0.3">
              <animate attributeName="cy" values="30;160;30" dur="6s" repeatCount="indefinite"/>
            </circle>
            <text x="400" y="60" text-anchor="middle" font-family="Segoe UI, Arial" font-size="36" font-weight="bold" fill="#ffffff">${greeting}! I'm Mohamed Raafat</text>
            <text x="400" y="100" text-anchor="middle" font-family="Segoe UI, Arial" font-size="18" fill="#8b949e">Software Engineer Intern @ Microsoft | .NET Developer</text>
            <text x="200" y="145" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">üë• ${userData.followers} followers</text>
            <text x="350" y="145" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">üì¶ ${userData.public_repos} repos</text>
            <text x="500" y="145" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">‚≠ê ${userData.following} following</text>
          </svg>`;
          }

          function styleMatrix(userData, greeting) {
            let drops = '';
            for (let i = 0; i < 20; i++) {
              const x = 30 + i * 40;
              const delay = Math.floor(Math.random() * 3);
              const dur = 2 + Math.floor(Math.random() * 2);
              drops += '<text x="' + x + '" y="-20" font-family="monospace" font-size="14" fill="#00ff41" opacity="0.3">01<animate attributeName="y" values="-20;200" dur="' + dur + 's" begin="' + delay + 's" repeatCount="indefinite"/></text>';
            }
            return `<svg width="800" height="180" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="bg2" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#0a0a0a"/>
                <stop offset="100%" style="stop-color:#001a00"/>
              </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#bg2)" rx="10"/>
            ${drops}
            <rect x="100" y="30" width="600" height="120" fill="#0a0a0a" fill-opacity="0.8" rx="8"/>
            <text x="400" y="70" text-anchor="middle" font-family="Courier New, monospace" font-size="32" font-weight="bold" fill="#00ff41">${greeting}! I'm Mohamed Raafat</text>
            <text x="400" y="105" text-anchor="middle" font-family="Courier New, monospace" font-size="16" fill="#00aa30">Software Engineer Intern @ Microsoft | .NET Developer</text>
            <text x="200" y="140" font-family="monospace" font-size="13" fill="#00ff41">üë• ${userData.followers}</text>
            <text x="350" y="140" font-family="monospace" font-size="13" fill="#00ff41">üì¶ ${userData.public_repos}</text>
            <text x="500" y="140" font-family="monospace" font-size="13" fill="#00ff41">‚≠ê ${userData.following}</text>
          </svg>`;
          }

          function styleAurora(userData, greeting) {
            return `<svg width="800" height="180" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="aurora" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#0d1117">
                  <animate attributeName="stop-color" values="#0d1117;#1a1a2e;#0d1117" dur="5s" repeatCount="indefinite"/>
                </stop>
                <stop offset="50%" style="stop-color:#1e3a5f">
                  <animate attributeName="stop-color" values="#1e3a5f;#2d5a87;#1e3a5f" dur="5s" repeatCount="indefinite"/>
                </stop>
                <stop offset="100%" style="stop-color:#0f3460">
                  <animate attributeName="stop-color" values="#0f3460;#1a4a7a;#0f3460" dur="5s" repeatCount="indefinite"/>
                </stop>
              </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#aurora)" rx="10"/>
            <path d="M0,140 Q200,100 400,140 T800,140 L800,180 L0,180 Z" fill="#58a6ff" opacity="0.1">
              <animate attributeName="d" values="M0,140 Q200,100 400,140 T800,140 L800,180 L0,180 Z;M0,140 Q200,160 400,120 T800,140 L800,180 L0,180 Z;M0,140 Q200,100 400,140 T800,140 L800,180 L0,180 Z" dur="4s" repeatCount="indefinite"/>
            </path>
            <path d="M0,150 Q200,120 400,150 T800,150 L800,180 L0,180 Z" fill="#58a6ff" opacity="0.15">
              <animate attributeName="d" values="M0,150 Q200,120 400,150 T800,150 L800,180 L0,180 Z;M0,150 Q200,170 400,130 T800,150 L800,180 L0,180 Z;M0,150 Q200,120 400,150 T800,150 L800,180 L0,180 Z" dur="3s" repeatCount="indefinite"/>
            </path>
            <text x="400" y="55" text-anchor="middle" font-family="Segoe UI, Arial" font-size="36" font-weight="bold" fill="#ffffff">${greeting}! I'm Mohamed Raafat</text>
            <text x="400" y="90" text-anchor="middle" font-family="Segoe UI, Arial" font-size="18" fill="#c0c0c0">Software Engineer Intern @ Microsoft | .NET Developer</text>
            <text x="200" y="125" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">üë• ${userData.followers} followers</text>
            <text x="400" y="125" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">üì¶ ${userData.public_repos} repos</text>
            <text x="580" y="125" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">‚≠ê ${userData.following} following</text>
          </svg>`;
          }

          function styleHexagon(userData, greeting) {
            let hexagons = '';
            const positions = [[50,40],[120,80],[700,50],[750,120],[380,150],[620,30]];
            positions.forEach(function(pos, i) {
              const x = pos[0];
              const y = pos[1];
              const size = 15 + Math.floor(Math.random() * 10);
              const opacity = (0.1 + Math.random() * 0.2).toFixed(2);
              const dur = 2 + i * 0.5;
              hexagons += '<polygon points="' + x + ',' + (y-size) + ' ' + (x+size*0.866) + ',' + (y-size/2) + ' ' + (x+size*0.866) + ',' + (y+size/2) + ' ' + x + ',' + (y+size) + ' ' + (x-size*0.866) + ',' + (y+size/2) + ' ' + (x-size*0.866) + ',' + (y-size/2) + '" fill="none" stroke="#58a6ff" stroke-width="1" opacity="' + opacity + '"><animate attributeName="opacity" values="' + opacity + ';' + (parseFloat(opacity)+0.2) + ';' + opacity + '" dur="' + dur + 's" repeatCount="indefinite"/></polygon>';
            });
            return `<svg width="800" height="180" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="bg4" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#0d1117"/>
                <stop offset="100%" style="stop-color:#161b22"/>
              </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#bg4)" rx="10"/>
            ${hexagons}
            <text x="400" y="55" text-anchor="middle" font-family="Segoe UI, Arial" font-size="36" font-weight="bold" fill="#ffffff">${greeting}! I'm Mohamed Raafat</text>
            <text x="400" y="90" text-anchor="middle" font-family="Segoe UI, Arial" font-size="18" fill="#8b949e">Software Engineer Intern @ Microsoft | .NET Developer</text>
            <text x="200" y="130" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">üë• ${userData.followers} followers</text>
            <text x="400" y="130" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">üì¶ ${userData.public_repos} repos</text>
            <text x="580" y="130" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">‚≠ê ${userData.following} following</text>
          </svg>`;
          }

          function stylePulse(userData, greeting) {
            return `<svg width="800" height="180" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="bg5" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#0d1117"/>
                <stop offset="100%" style="stop-color:#1a1a2e"/>
              </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#bg5)" rx="10"/>
            <circle cx="100" cy="90" r="20" fill="none" stroke="#58a6ff" stroke-width="1" opacity="0.3">
              <animate attributeName="r" values="20;60;20" dur="3s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.3;0;0.3" dur="3s" repeatCount="indefinite"/>
            </circle>
            <circle cx="700" cy="90" r="20" fill="none" stroke="#58a6ff" stroke-width="1" opacity="0.3">
              <animate attributeName="r" values="20;60;20" dur="4s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.3;0;0.3" dur="4s" repeatCount="indefinite"/>
            </circle>
            <circle cx="400" cy="90" r="30" fill="none" stroke="#58a6ff" stroke-width="2" opacity="0.2">
              <animate attributeName="r" values="30;100;30" dur="5s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.2;0;0.2" dur="5s" repeatCount="indefinite"/>
            </circle>
            <text x="400" y="55" text-anchor="middle" font-family="Segoe UI, Arial" font-size="36" font-weight="bold" fill="#ffffff">${greeting}! I'm Mohamed Raafat</text>
            <text x="400" y="90" text-anchor="middle" font-family="Segoe UI, Arial" font-size="18" fill="#8b949e">Software Engineer Intern @ Microsoft | .NET Developer</text>
            <text x="200" y="130" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">üë• ${userData.followers} followers</text>
            <text x="400" y="130" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">üì¶ ${userData.public_repos} repos</text>
            <text x="580" y="130" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">‚≠ê ${userData.following} following</text>
          </svg>`;
          }

          function styleStarfield(userData, greeting) {
            let stars = '';
            for (let i = 0; i < 30; i++) {
              const x = Math.floor(Math.random() * 800);
              const y = Math.floor(Math.random() * 180);
              const size = (0.5 + Math.random() * 1.5).toFixed(1);
              const dur = (1 + Math.random() * 2).toFixed(1);
              stars += '<circle cx="' + x + '" cy="' + y + '" r="' + size + '" fill="#ffffff" opacity="0.4"><animate attributeName="opacity" values="0.4;0.8;0.4" dur="' + dur + 's" repeatCount="indefinite"/></circle>';
            }
            return `<svg width="800" height="180" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#0a0a1a" rx="10"/>
            ${stars}
            <text x="400" y="55" text-anchor="middle" font-family="Segoe UI, Arial" font-size="36" font-weight="bold" fill="#ffffff">${greeting}! I'm Mohamed Raafat</text>
            <text x="400" y="90" text-anchor="middle" font-family="Segoe UI, Arial" font-size="18" fill="#a0a0b0">Software Engineer Intern @ Microsoft | .NET Developer</text>
            <text x="200" y="130" font-family="Segoe UI, Arial" font-size="14" fill="#7aa2f7">üë• ${userData.followers} followers</text>
            <text x="400" y="130" font-family="Segoe UI, Arial" font-size="14" fill="#7aa2f7">üì¶ ${userData.public_repos} repos</text>
            <text x="580" y="130" font-family="Segoe UI, Arial" font-size="14" fill="#7aa2f7">‚≠ê ${userData.following} following</text>
          </svg>`;
          }

          function generateHeaderSVG(userData) {
            const now = new Date();
            const hour = (now.getUTCHours() + 2) % 24;
            const greeting = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';
            
            const styles = [styleParticles, styleMatrix, styleAurora, styleHexagon, stylePulse, styleStarfield];
            const randomStyle = styles[Math.floor(Math.random() * styles.length)];
            
            console.log('üé® Selected style: ' + randomStyle.name);
            return randomStyle(userData, greeting);
          }

          async function main() {
            try {
              const userData = await fetchGitHubData();
              
              if (!fs.existsSync('dynamic-svg')) {
                fs.mkdirSync('dynamic-svg', { recursive: true });
              }
              
              fs.writeFileSync('dynamic-svg/header.svg', generateHeaderSVG(userData));
              
              console.log('‚úÖ Header SVG generated successfully!');
              console.log('üìä User: ' + userData.login);
            } catch (error) {
              console.error('Error:', error);
              process.exit(1);
            }
          }

          main();
          EOF
      
      - name: Generate Dynamic SVGs
        run: node generate-svg.js
      
      - name: Commit and Push
        run: |
          cp -r dynamic-svg /tmp/dynamic-svg-new
          git fetch origin master
          git reset --hard origin/master
          mkdir -p dynamic-svg
          cp -r /tmp/dynamic-svg-new/* dynamic-svg/
          
          # Update README with cache-busting timestamp
          TIMESTAMP=$(date +%s)
          sed -i "s|dynamic-svg/header.svg[^\"]*\"|dynamic-svg/header.svg?v=${TIMESTAMP}\"|g" README.md
          
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git add dynamic-svg/ README.md
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "üé® Update header SVG"
          git push origin master
