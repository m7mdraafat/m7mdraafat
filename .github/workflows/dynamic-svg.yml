name: Generate Dynamic Profile SVGs

on:
  schedule:
    - cron: "*/10 * * * *" # Every 10 minutes
  workflow_dispatch:

jobs:
  generate-svg:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Create SVG Generator
        run: |
          mkdir -p dynamic-svg
          cat > generate-svg.js << 'EOF'
          const https = require('https');
          const fs = require('fs');

          const username = 'm7mdraafat';

          // Fetch GitHub user data
          function fetchGitHubData() {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'api.github.com',
                path: `/users/${username}`,
                headers: { 'User-Agent': 'GitHub-Profile-Generator' }
              };
              
              https.get(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              }).on('error', reject);
            });
          }

          // Generate animated header SVG
          function generateHeaderSVG(userData) {
            const now = new Date();
            const hour = (now.getUTCHours() + 2) % 24; // Cairo timezone
            const greeting = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';
            
            return `
          <svg width="800" height="180" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#0d1117"/>
                <stop offset="50%" style="stop-color:#1a1a2e"/>
                <stop offset="100%" style="stop-color:#16213e"/>
              </linearGradient>
              <filter id="glow">
                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            
            <rect width="100%" height="100%" fill="url(#headerGrad)" rx="10"/>
            
            <!-- Animated particles -->
            <circle cx="50" cy="50" r="2" fill="#58a6ff" opacity="0.6">
              <animate attributeName="cy" values="50;130;50" dur="4s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.6;0.2;0.6" dur="4s" repeatCount="indefinite"/>
            </circle>
            <circle cx="150" cy="90" r="1.5" fill="#58a6ff" opacity="0.4">
              <animate attributeName="cy" values="90;30;90" dur="3s" repeatCount="indefinite"/>
            </circle>
            <circle cx="650" cy="70" r="2" fill="#58a6ff" opacity="0.5">
              <animate attributeName="cy" values="70;150;70" dur="5s" repeatCount="indefinite"/>
            </circle>
            <circle cx="750" cy="100" r="1" fill="#c0c0c0" opacity="0.4">
              <animate attributeName="cy" values="100;40;100" dur="3.5s" repeatCount="indefinite"/>
            </circle>
            
            <!-- Main text with animation -->
            <text x="400" y="60" text-anchor="middle" font-family="Segoe UI, Arial" font-size="36" font-weight="bold" fill="#ffffff" filter="url(#glow)">
              ${greeting}! I'm Mohamed Raafat
              <animate attributeName="opacity" values="0;1" dur="1s" fill="freeze"/>
            </text>
            
            <text x="400" y="100" text-anchor="middle" font-family="Segoe UI, Arial" font-size="18" fill="#8b949e">
              Software Engineer Intern @ Microsoft | .NET Developer
              <animate attributeName="opacity" values="0;1" dur="1s" begin="0.5s" fill="freeze"/>
            </text>
            
            <!-- Stats with animation -->
            <g transform="translate(200, 140)">
              <text x="0" y="0" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">
                üë• ${userData.followers} followers
                <animate attributeName="opacity" values="0;1" dur="0.5s" begin="1s" fill="freeze"/>
              </text>
              <text x="150" y="0" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">
                üì¶ ${userData.public_repos} repositories
                <animate attributeName="opacity" values="0;1" dur="0.5s" begin="1.2s" fill="freeze"/>
              </text>
              <text x="330" y="0" font-family="Segoe UI, Arial" font-size="14" fill="#58a6ff">
                ‚≠ê ${userData.following} following
                <animate attributeName="opacity" values="0;1" dur="0.5s" begin="1.4s" fill="freeze"/>
              </text>
            </g>
          </svg>`;
          }

          async function main() {
            try {
              const userData = await fetchGitHubData();
              
              // Create directory
              if (!fs.existsSync('dynamic-svg')) {
                fs.mkdirSync('dynamic-svg', { recursive: true });
              }
              
              // Generate header SVG only
              fs.writeFileSync('dynamic-svg/header.svg', generateHeaderSVG(userData));
              
              console.log('‚úÖ Header SVG generated successfully!');
              console.log(`üìä User: ${userData.login}`);
            } catch (error) {
              console.error('Error:', error);
              process.exit(1);
            }
          }

          main();
          EOF
      
      - name: Generate Dynamic SVGs
        run: node generate-svg.js
      
      - name: Commit and Push
        run: |
          # Save generated files
          cp -r dynamic-svg /tmp/dynamic-svg-new
          
          # Fetch and reset to latest remote
          git fetch origin master
          git reset --hard origin/master
          
          # Restore generated files
          mkdir -p dynamic-svg
          cp -r /tmp/dynamic-svg-new/* dynamic-svg/
          
          # Configure git and commit
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git add dynamic-svg/
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "üé® Update header SVG"
          git push origin master
